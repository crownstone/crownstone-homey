/*!
 * homey v0.1.0-beta.13
 * https://github.com/demiazz/homey
 *
 * Copyright 2017-present Alexey Plutalov <demiazz.py@gmail.com>
 * Released under the MIT license
 *
 * @flow
 */

import type {
  CSSSelector,
  CustomEventHandler,
  DelegateEvent,
  DelegateEventHandler,
  EventType
} from "../types";

import matches from "./matches";
import parent from "./parent";
import on from "./on";

declare function delegate(
  target: EventTarget,
  selector: CSSSelector,
  eventType: MouseEventTypes,
  handler: MouseEventHandler,
  useCapture?: boolean
): () => void;

declare function delegate(
  target: EventTarget,
  selector: CSSSelector,
  eventType: FocusEventTypes,
  handler: FocusEventHandler,
  useCapture?: boolean
): () => void;

declare function delegate(
  target: EventTarget,
  selector: CSSSelector,
  eventType: KeyboardEventTypes,
  handler: KeyboardEventHandler,
  useCapture?: boolean
): () => void;

declare function delegate(
  target: EventTarget,
  selector: CSSSelector,
  eventType: TouchEventTypes,
  handler: TouchEventHandler,
  useCapture?: boolean
): () => void;

declare function delegate(
  target: EventTarget,
  selector: CSSSelector,
  eventType: WheelEventTypes,
  handler: WheelEventHandler,
  useCapture?: boolean
): () => void;

declare function delegate(
  target: EventTarget,
  selector: CSSSelector,
  eventType: ProgressEventTypes,
  ler: ProgressEventHandler,
  useCapture?: boolean
): () => void;

declare function delegate(
  target: EventTarget,
  selector: CSSSelector,
  eventType: DragEventTypes,
  handler: DragEventHandler,
  useCapture?: boolean
): () => void;

declare function delegate(
  target: EventTarget,
  selector: CSSSelector,
  eventType: AnimationEventTypes,
  handler: AnimationEventHandler,
  useCapture?: boolean
): () => void;

declare function delegate(
  target: EventTarget,
  selector: CSSSelector,
  eventType: EventType,
  handler: CustomEventHandler,
  useCapture?: boolean
): () => void;

declare function delegate(
  target: EventTarget,
  selector: CSSSelector,
  eventType: EventType,
  handler: DelegateEventHandler,
  useCapture?: boolean
): () => void;

declare function delegate(
  target: EventTarget,
  selector: CSSSelector,
  eventType: EventType,
  handler: EventHandler,
  useCapture?: boolean
): () => void;

function delegate(target, selector, eventType, handler, useCapture = false) {
  function wrappedHandler(event) {
    if (!(event.target instanceof Element)) {
      return;
    }

    let current = event.target;

    while (current) {
      if (matches(current, selector)) {
        ((event: any): DelegateEvent).delegateTarget = target;

        handler(event);

        delete ((event: any): DelegateEvent).delegateTarget;

        return;
      }

      if (current === target) {
        return;
      }

      current = parent(current);
    }
  }

  return on(target, eventType, wrappedHandler, useCapture);
}

export default delegate;
